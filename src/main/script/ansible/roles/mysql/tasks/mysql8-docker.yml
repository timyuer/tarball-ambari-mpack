# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

- name: 安装 Docker CE
  yum:
    name: docker-ce
    state: present

- name: 启动 Docker 服务
  service:
    name: docker
    state: started
    enabled: yes

- name: 创建 /opt/mysql 目录（如果不存在）
  file:
    path: /opt/mysql
    state: directory
    mode: "0755"

- name: 下载 MySQL 镜像
  get_url:
    url: "{{ mysql_image_url }}"
    dest: "{{ dest_path }}"
    force: yes

- name: 加载离线 Docker 镜像
  shell: docker load -i "{{ dest_path }}" && rm -f "{{ dest_path }}"

- name: 生成 my.cnf 配置文件
  copy:
    dest: /opt/mysql/my.cnf
    content: |
      [client]
      port= 3306
      socket= /tmp/mysql.sock

      [mysqld]
      # 时区
      default-time-zone = '+8:00'
      # 字符集
      character_set_server=utf8mb4
      collation_server=utf8mb4_0900_ai_ci
      port= 3306
      socket= /tmp/mysql.sock
      datadir = /var/lib/mysql
      pid_file = /var/lib/mysql/localhost.localdomain.pid
      default_storage_engine = InnoDB
      key_buffer_size = 8M
      max_allowed_packet = 100G
      table_open_cache = 32
      sort_buffer_size = 256K
      net_buffer_length = 4K
      read_buffer_size = 128K
      read_rnd_buffer_size = 256K
      myisam_sort_buffer_size = 4M
      thread_cache_size = 4
      tmp_table_size = 8M
      sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES

      max_connections = 1000
      max_connect_errors = 100
      open_files_limit = 65535
      wait_timeout = 3600
      interactive_timeout = 3600

      # 开启二进制日志
      log-bin=mysql-bin
      # bin log日志每达到设定大小后，会使用新的bin log日志
      max_binlog_size=500M
      # 选择 ROW 模式
      binlog_format=ROW
      binlog_expire_logs_seconds = 1296000
      server-id = 1
      slow_query_log = ON
      slow-query-log-file = /var/lib/mysql/mysql-slow.log
      long_query_time = 3



      innodb_data_home_dir = /var/lib/mysql
      innodb_data_file_path = ibdata1:10M:autoextend
      innodb_log_group_home_dir = /var/lib/mysql
      innodb_buffer_pool_size = 16M
      innodb_log_file_size = 5M
      innodb_log_buffer_size = 8M
      innodb_flush_log_at_trx_commit = 1
      innodb_lock_wait_timeout = 50
      innodb_max_dirty_pages_pct = 90
      innodb_read_io_threads = 8
      innodb_write_io_threads = 8
      # 修改innodb_page_size的值为32k,不能动
      innodb_page_size = 32k

      [mysqldump]
      quick
      max_allowed_packet = 500M

      [mysql]
      no-auto-rehash

      [myisamchk]
      key_buffer_size = 20M
      sort_buffer_size = 20M
      read_buffer = 2M
      write_buffer = 2M
    mode: "0644"

- name: 运行 MySQL 8.0.41 容器
  shell: |
    docker rm -f mysql && \
    docker run --restart=always -it -d \
    --network host \
    --name mysql \
    -v mysql_data:/var/lib/mysql \
    -v /opt/mysql/my.cnf:/etc/mysql/my.cnf \
    -e MYSQL_ROOT_PASSWORD=i@1LH*I%Wju9 \
    mysql:8.0.41